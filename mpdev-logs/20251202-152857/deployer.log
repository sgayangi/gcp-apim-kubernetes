+ trap handle_failure EXIT
+ test_schema=/data-test/schema.yaml
+ overlay_test_schema.py --test_schema /data-test/schema.yaml --original_schema /data/schema.yaml --output /data/schema.yaml
+ awk '{print "SMOKE_TEST "$0}'
++ /bin/print_config.py --xtype NAME --values_mode raw
+ NAME=apptest-5mjr3ks3
++ /bin/print_config.py --xtype NAMESPACE --values_mode raw
Deploying application "apptest-5mjr3ks3" in test mode
+ NAMESPACE=apptest-5mjr3ks3
+ export NAME
+ export NAMESPACE
+ echo 'Deploying application "apptest-5mjr3ks3" in test mode'
++ kubectl get applications.app.k8s.io/apptest-5mjr3ks3 --namespace=apptest-5mjr3ks3 '--output=jsonpath={.metadata.uid}'
Using /opt/kubectl/1.31/kubectl (server=1.32)
+ app_uid=a82f27f1-84ff-4545-9bdb-186e532a17aa
++ kubectl get applications.app.k8s.io/apptest-5mjr3ks3 --namespace=apptest-5mjr3ks3 '--output=jsonpath={.apiVersion}'
Using /opt/kubectl/1.31/kubectl (server=1.32)
+ app_api_version=app.k8s.io/v1beta1
++ kubectl get namespaces/apptest-5mjr3ks3 '--output=jsonpath={.metadata.uid}'
Using /opt/kubectl/1.31/kubectl (server=1.32)
+ namespace_uid=18f89eb9-7f9b-4df9-abca-3ee9f9e6d627
+ /bin/expand_config.py --values_mode raw --app_uid a82f27f1-84ff-4545-9bdb-186e532a17aa
+ create_manifests.sh --mode=test
+ for i in "$@"
+ case $i in
+ mode=test
+ shift
+ [[ -z apptest-5mjr3ks3 ]]
+ [[ -z apptest-5mjr3ks3 ]]
+ echo 'Creating the manifests for the kubernetes resources that build the application "apptest-5mjr3ks3"'
+ data_dir=/data
+ manifest_dir=/data/manifest-expanded
+ mkdir -p /data/manifest-expanded
Creating the manifests for the kubernetes resources that build the application "apptest-5mjr3ks3"
+ [[ test = \t\e\s\t ]]
+ test_data_dir=/data-test
+ mkdir -p /data-test
+ extract_manifest /data
+ data=/data
+ extracted=/data/extracted
+ data_chart=/data/chart
+ mkdir -p /data/extracted
+ [[ -d /data/chart ]]
++ find /data/chart -maxdepth 1 -type f -name '*.tar.gz'
+ for chart in $(find "$data_chart" -maxdepth 1 -type f -name "*.tar.gz")
++ basename /data/chart/chart.tar.gz
++ sed 's/.tar.gz$//'
+ chart_manifest_file=chart
+ mkdir /data/extracted/chart
+ tar xfC /data/chart/chart.tar.gz /data/extracted/chart
+ [[ test = \t\e\s\t ]]
+ extract_manifest /data-test
+ data=/data-test
+ extracted=/data-test/extracted
+ data_chart=/data-test/chart
+ mkdir -p /data-test/extracted
+ [[ -d /data-test/chart ]]
++ find /data-test/chart -maxdepth 1 -type f -name '*.tar.gz'
+ [[ ! -e /data/extracted ]]
+ overlay_test_files.py --manifest /data/extracted --test_manifest /data-test/extracted
+ awk '{print "SMOKE_TEST "$0}'
+ echo '=== values.yaml ==='
+ /bin/print_config.py --output=yaml
=== values.yaml ===
adapterImage: us-docker.pkg.dev/wso2-marketplace-public/wso2-marketplace/apk-adapter:4.5.0
apimApkAgentImage: us-docker.pkg.dev/wso2-marketplace-public/wso2-marketplace/apim-apk-agent:4.5.0
commonControllerImage: us-docker.pkg.dev/wso2-marketplace-public/wso2-marketplace/apk-common-controller:4.5.0
configDeployerImage: us-docker.pkg.dev/wso2-marketplace-public/wso2-marketplace/apk-config-deployer-service:4.5.0
controller:
  serviceAccount: apptest-5mjr3ks3-controller-serviceaccount
enforcerImage: us-docker.pkg.dev/wso2-marketplace-public/wso2-marketplace/apk-enforcer:4.5.0
name: apptest-5mjr3ks3
namespace: apptest-5mjr3ks3
ratelimiterImage: us-docker.pkg.dev/wso2-marketplace-public/wso2-marketplace/apk-ratelimiter:4.5.0
routerImage: us-docker.pkg.dev/wso2-marketplace-public/wso2-marketplace/apk-router:4.5.0
wso2amAcpImage: us-docker.pkg.dev/wso2-marketplace-public/wso2-marketplace/wso2am-acp:4.5.0
+ echo ===================
===================
+ for chart in "$data_dir/extracted"/*
++ basename /data/extracted/chart
++ sed 's/.tar.gz$//'
+ chart_manifest_file=chart.yaml
+ helm template apptest-5mjr3ks3 /data/extracted/chart/chart --namespace=apptest-5mjr3ks3 --values=/dev/fd/63
++ /bin/print_config.py --output=yaml
coalesce.go:298: warning: cannot overwrite table with non table for wso2-apim.acp.wso2.deployment.image (map[digest: imagePullPolicy:Always registry: repository:])
coalesce.go:298: warning: cannot overwrite table with non table for wso2-apim.acp.wso2.deployment.image (map[digest: imagePullPolicy:Always registry: repository:])
coalesce.go:298: warning: cannot overwrite table with non table for wso2-apim.acp.wso2.deployment.image (map[digest: imagePullPolicy:Always registry: repository:])
+ [[ test != \t\e\s\t ]]
+ process_helm_hooks.py --deploy_tests --manifest /data/manifest-expanded/chart.yaml
INFO Reading /data/manifest-expanded/chart.yaml
+ ensure_k8s_apps_labels.py --manifest /data/manifest-expanded/chart.yaml --appname apptest-5mjr3ks3
INFO Reading /data/manifest-expanded/chart.yaml
+ /bin/set_ownership.py --app_name apptest-5mjr3ks3 --app_uid a82f27f1-84ff-4545-9bdb-186e532a17aa --app_api_version app.k8s.io/v1beta1 --namespace apptest-5mjr3ks3 --namespace_uid 18f89eb9-7f9b-4df9-abca-3ee9f9e6d627 --manifests /data/manifest-expanded --dest /data/resources.yaml
INFO Reading /data/manifest-expanded/chart.yaml
INFO Application 'apptest-5mjr3ks3' owns 'Secret/apk-root-certificate'
INFO Application 'apptest-5mjr3ks3' owns 'Secret/apptest-5mjr3ks3-wso2-apk-adapter-truststore-consul-secret'
INFO Application 'apptest-5mjr3ks3' owns 'Secret/apptest-5mjr3ks3-wso2-apk-sts-shared-auth-key'
INFO Application 'apptest-5mjr3ks3' owns 'Secret/apptest-5mjr3ks3-wso2-apk-enforcer-keystore-secret'
INFO Application 'apptest-5mjr3ks3' owns 'Secret/apptest-5mjr3ks3-wso2-apk-enforcer-truststore-secret'
INFO Application 'apptest-5mjr3ks3' owns 'Secret/apptest-5mjr3ks3-wso2-apk-token'
INFO Application 'apptest-5mjr3ks3' owns 'Secret/apim-apk-issuer-cert'
INFO Application 'apptest-5mjr3ks3' owns 'Secret/apk-agent-root-certificate'
INFO Application 'apptest-5mjr3ks3' owns 'Secret/agent-account-secret-token'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/apptest-5mjr3ks3-acp-conf-1'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/apptest-5mjr3ks3-acp-conf-entrypoint'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/apptest-5mjr3ks3-acp-conf-log4j2'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/apptest-5mjr3ks3-acp-conf-admin-settings'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/apptest-5mjr3ks3-acp-conf-devportal-settings'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/apptest-5mjr3ks3-acp-conf-publisher-settings'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/redis-configuration'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/redis-health'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/redis-scripts'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/apptest-5mjr3ks3-wso2-apk-config-ds-configmap'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/apptest-5mjr3ks3-wso2-apk-wso2-apk-config-deployer-api-definition'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/apptest-5mjr3ks3-wso2-apk-wso2-apk-config-generator-api-definition'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/apptest-5mjr3ks3-wso2-apk-adapter-grpc-probe-script-conf'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/apptest-5mjr3ks3-wso2-apk-notification-api-definition'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/apptest-5mjr3ks3-wso2-apk-common-controller-grpc-probe-script-conf'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/apptest-5mjr3ks3-wso2-apk-common-log-conf'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/apptest-5mjr3ks3-wso2-apk-enforcer-grpc-probe-script-conf'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/apptest-5mjr3ks3-wso2-apk-log-conf'
INFO Application 'apptest-5mjr3ks3' owns 'ConfigMap/apptest-5mjr3ks3-log-conf'
INFO Namespace 'apptest-5mjr3ks3' owns 'ClusterRole/wso2apk-role'
INFO Namespace 'apptest-5mjr3ks3' owns 'ClusterRole/wso2agent-role'
INFO Namespace 'apptest-5mjr3ks3' owns 'ClusterRoleBinding/apptest-5mjr3ks3-wso2-apk-role-binding'
INFO Namespace 'apptest-5mjr3ks3' owns 'ClusterRoleBinding/agent-cluster-role-binding'
INFO Application 'apptest-5mjr3ks3' owns 'Service/apptest-5mjr3ks3-acp-1-service'
INFO Application 'apptest-5mjr3ks3' owns 'Service/apptest-5mjr3ks3-acp-service'
INFO Application 'apptest-5mjr3ks3' owns 'Service/redis-headless'
INFO Application 'apptest-5mjr3ks3' owns 'Service/redis-master'
INFO Application 'apptest-5mjr3ks3' owns 'Service/apptest-5mjr3ks3-wso2-apk-config-ds-service'
INFO Application 'apptest-5mjr3ks3' owns 'Service/apptest-5mjr3ks3-wso2-apk-adapter-service'
INFO Application 'apptest-5mjr3ks3' owns 'Service/apptest-5mjr3ks3-wso2-apk-common-controller-service'
INFO Application 'apptest-5mjr3ks3' owns 'Service/apptest-5mjr3ks3-wso2-apk-enforcer-service'
INFO Application 'apptest-5mjr3ks3' owns 'Service/apptest-5mjr3ks3-wso2-apk-gateway-service'
INFO Application 'apptest-5mjr3ks3' owns 'Service/apptest-5mjr3ks3-wso2-apk-ratelimiter-service'
INFO Application 'apptest-5mjr3ks3' owns 'Service/apim-apk-agent-service'
INFO Application 'apptest-5mjr3ks3' owns 'Deployment/apptest-5mjr3ks3-acp-deployment-1'
INFO Application 'apptest-5mjr3ks3' owns 'Deployment/apptest-5mjr3ks3-wso2-apk-config-ds-deployment'
INFO Application 'apptest-5mjr3ks3' owns 'Deployment/apptest-5mjr3ks3-wso2-apk-adapter-deployment'
INFO Application 'apptest-5mjr3ks3' owns 'Deployment/apptest-5mjr3ks3-wso2-apk-common-controller-deployment'
INFO Application 'apptest-5mjr3ks3' owns 'Deployment/apptest-5mjr3ks3-wso2-apk-gateway-runtime-deployment'
INFO Application 'apptest-5mjr3ks3' owns 'Deployment/apptest-5mjr3ks3-wso2-apk-ratelimiter-deployment'
INFO Application 'apptest-5mjr3ks3' owns 'Deployment/apkagent'
INFO Application 'apptest-5mjr3ks3' owns 'StatefulSet/redis-master'
+ validate_app_resource.py --manifests /data/resources.yaml
INFO Reading /data/resources.yaml
+ separate_tester_resources.py --app_uid a82f27f1-84ff-4545-9bdb-186e532a17aa --app_name apptest-5mjr3ks3 --app_api_version app.k8s.io/v1beta1 --manifests /data/resources.yaml --out_manifests /data/resources.yaml --out_test_manifests /data/tester.yaml
INFO Reading /data/resources.yaml
INFO Prod resource: NetworkPolicy/redis
INFO Prod resource: PodDisruptionBudget/apptest-5mjr3ks3-acp-pdb
INFO Prod resource: PodDisruptionBudget/redis-master
INFO Prod resource: ServiceAccount/redis-master
INFO Prod resource: ServiceAccount/wso2apk-platform
INFO Prod resource: ServiceAccount/wso2agent-platform
INFO Prod resource: Secret/apk-root-certificate
INFO Prod resource: Secret/apptest-5mjr3ks3-wso2-apk-adapter-truststore-consul-secret
INFO Prod resource: Secret/apptest-5mjr3ks3-wso2-apk-sts-shared-auth-key
INFO Prod resource: Secret/apptest-5mjr3ks3-wso2-apk-enforcer-keystore-secret
INFO Prod resource: Secret/apptest-5mjr3ks3-wso2-apk-enforcer-truststore-secret
INFO Prod resource: Secret/apptest-5mjr3ks3-wso2-apk-token
INFO Prod resource: Secret/apim-apk-issuer-cert
INFO Prod resource: Secret/apk-agent-root-certificate
INFO Prod resource: Secret/agent-account-secret-token
INFO Prod resource: ConfigMap/apptest-5mjr3ks3-acp-conf-1
INFO Prod resource: ConfigMap/apptest-5mjr3ks3-acp-conf-entrypoint
INFO Prod resource: ConfigMap/apptest-5mjr3ks3-acp-conf-log4j2
INFO Prod resource: ConfigMap/apptest-5mjr3ks3-acp-conf-admin-settings
INFO Prod resource: ConfigMap/apptest-5mjr3ks3-acp-conf-devportal-settings
INFO Prod resource: ConfigMap/apptest-5mjr3ks3-acp-conf-publisher-settings
INFO Prod resource: ConfigMap/redis-configuration
INFO Prod resource: ConfigMap/redis-health
INFO Prod resource: ConfigMap/redis-scripts
INFO Prod resource: ConfigMap/apptest-5mjr3ks3-wso2-apk-config-ds-configmap
INFO Prod resource: ConfigMap/apptest-5mjr3ks3-wso2-apk-wso2-apk-config-deployer-api-definition
INFO Prod resource: ConfigMap/apptest-5mjr3ks3-wso2-apk-wso2-apk-config-generator-api-definition
INFO Prod resource: ConfigMap/apptest-5mjr3ks3-wso2-apk-adapter-grpc-probe-script-conf
INFO Prod resource: ConfigMap/apptest-5mjr3ks3-wso2-apk-notification-api-definition
INFO Prod resource: ConfigMap/apptest-5mjr3ks3-wso2-apk-common-controller-grpc-probe-script-conf
INFO Prod resource: ConfigMap/apptest-5mjr3ks3-wso2-apk-common-log-conf
INFO Prod resource: ConfigMap/apptest-5mjr3ks3-wso2-apk-enforcer-grpc-probe-script-conf
INFO Prod resource: ConfigMap/apptest-5mjr3ks3-wso2-apk-log-conf
INFO Prod resource: ConfigMap/apptest-5mjr3ks3-log-conf
INFO Prod resource: ClusterRole/wso2apk-role
INFO Prod resource: ClusterRole/wso2agent-role
INFO Prod resource: ClusterRoleBinding/apptest-5mjr3ks3-wso2-apk-role-binding
INFO Prod resource: ClusterRoleBinding/agent-cluster-role-binding
INFO Prod resource: Service/apptest-5mjr3ks3-acp-1-service
INFO Prod resource: Service/apptest-5mjr3ks3-acp-service
INFO Prod resource: Service/redis-headless
INFO Prod resource: Service/redis-master
INFO Prod resource: Service/apptest-5mjr3ks3-wso2-apk-config-ds-service
INFO Prod resource: Service/apptest-5mjr3ks3-wso2-apk-adapter-service
INFO Prod resource: Service/apptest-5mjr3ks3-wso2-apk-common-controller-service
INFO Prod resource: Service/apptest-5mjr3ks3-wso2-apk-enforcer-service
INFO Prod resource: Service/apptest-5mjr3ks3-wso2-apk-gateway-service
INFO Prod resource: Service/apptest-5mjr3ks3-wso2-apk-ratelimiter-service
INFO Prod resource: Service/apim-apk-agent-service
INFO Prod resource: Deployment/apptest-5mjr3ks3-acp-deployment-1
INFO Prod resource: Deployment/apptest-5mjr3ks3-wso2-apk-config-ds-deployment
INFO Prod resource: Deployment/apptest-5mjr3ks3-wso2-apk-adapter-deployment
INFO Prod resource: Deployment/apptest-5mjr3ks3-wso2-apk-common-controller-deployment
INFO Prod resource: Deployment/apptest-5mjr3ks3-wso2-apk-gateway-runtime-deployment
INFO Prod resource: Deployment/apptest-5mjr3ks3-wso2-apk-ratelimiter-deployment
INFO Prod resource: Deployment/apkagent
INFO Prod resource: StatefulSet/redis-master
INFO Prod resource: Ingress/apptest-5mjr3ks3-acp-ingress
INFO Prod resource: AIProvider/ai-provider-azure-ai
INFO Prod resource: AIProvider/ai-provider-mistral-ai
INFO Prod resource: AIProvider/ai-provider-open-ai
INFO Prod resource: API/apptest-5mjr3ks3-wso2-apk-wso2-apk-config-deployer-api
INFO Prod resource: API/apptest-5mjr3ks3-wso2-apk-wso2-apk-config-generator-api
INFO Prod resource: API/apptest-5mjr3ks3-wso2-apk-wso2-apk-notification-api
INFO Prod resource: APIPolicy/apptest-5mjr3ks3-wso2-apk-config-api-api-policy
INFO Prod resource: Application/apptest-5mjr3ks3
INFO Prod resource: Authentication/apptest-5mjr3ks3-wso2-apk-configurator-api-no-authentication-policy
INFO Prod resource: Authentication/apptest-5mjr3ks3-wso2-apk-notification-api-no-authentication-policy
INFO Prod resource: Backend/apptest-5mjr3ks3-wso2-apk-config-deployer-ds-backend
INFO Prod resource: Backend/apptest-5mjr3ks3-wso2-apk-config-generator-backend
INFO Prod resource: Backend/apptest-5mjr3ks3-wso2-apk-notification-api-backend
INFO Prod resource: BackendJWT/apptest-5mjr3ks3-wso2-apk-config-api-backendjwt
INFO Prod resource: Certificate/apptest-5mjr3ks3-wso2-apk-adapter-server-cert
INFO Prod resource: Certificate/apptest-5mjr3ks3-wso2-apk-common-controller-server-cert
INFO Prod resource: Certificate/apptest-5mjr3ks3-wso2-apk-config-ds-server-cert
INFO Prod resource: Certificate/apptest-5mjr3ks3-wso2-apk-enforcer-server-cert
INFO Prod resource: Certificate/envoy-cert
INFO Prod resource: Certificate/apptest-5mjr3ks3-wso2-apk-gateway-server-cert
INFO Prod resource: Certificate/apptest-5mjr3ks3-wso2-apk-gw-listener-cert
INFO Prod resource: Certificate/apptest-5mjr3ks3-wso2-apk-idp-listener-cert
INFO Prod resource: Certificate/apptest-5mjr3ks3-wso2-apk-localhost-listener-cert
INFO Prod resource: Certificate/apptest-5mjr3ks3-wso2-apk-ratelimiter-server-cert
INFO Prod resource: Certificate/apptest-5mjr3ks3-wso2-apk-runtime-ds-server-cert
INFO Prod resource: Certificate/apptest-5mjr3ks3-wso2-apk-system-api-listener-cert
INFO Prod resource: Certificate/apptest-5mjr3ks3-wso2-apk-webhook-server-cert
INFO Prod resource: Certificate/apim-apk-agent-server-cert
INFO Prod resource: ClusterIssuer/apptest-5mjr3ks3-wso2-apk-selfsigned-issuer
INFO Prod resource: ClusterIssuer/apk-agent-selfsigned-issuer
INFO Prod resource: Gateway/wso2-apk-default
INFO Prod resource: GatewayClass/wso2-apk-default
INFO Prod resource: HTTPRoute/apptest-5mjr3ks3-wso2-apk-config-api-route
INFO Prod resource: HTTPRoute/apptest-5mjr3ks3-wso2-apk-config-deploy-api-route
INFO Prod resource: HTTPRoute/apptest-5mjr3ks3-wso2-apk-notification-api-route
INFO Prod resource: Scope/apptest-5mjr3ks3-wso2-apk-api-create-scope
INFO Prod resource: TokenIssuer/apptest-5mjr3ks3-wso2-apk-default-jwt-issuer
INFO Prod resource: TokenIssuer/apptest-5mjr3ks3-wso2-apk-idp-jwt-issuer
+ kubectl apply --namespace=apptest-5mjr3ks3 --filename=/data/resources.yaml
Using /opt/kubectl/1.31/kubectl (server=1.32)
networkpolicy.networking.k8s.io/redis created
poddisruptionbudget.policy/apptest-5mjr3ks3-acp-pdb created
poddisruptionbudget.policy/redis-master created
serviceaccount/redis-master created
serviceaccount/wso2apk-platform created
serviceaccount/wso2agent-platform created
secret/apk-root-certificate created
secret/apptest-5mjr3ks3-wso2-apk-adapter-truststore-consul-secret created
secret/apptest-5mjr3ks3-wso2-apk-sts-shared-auth-key created
secret/apptest-5mjr3ks3-wso2-apk-enforcer-keystore-secret created
secret/apptest-5mjr3ks3-wso2-apk-enforcer-truststore-secret created
secret/apptest-5mjr3ks3-wso2-apk-token created
secret/apim-apk-issuer-cert created
secret/apk-agent-root-certificate created
secret/agent-account-secret-token created
configmap/apptest-5mjr3ks3-acp-conf-1 created
configmap/apptest-5mjr3ks3-acp-conf-entrypoint created
configmap/apptest-5mjr3ks3-acp-conf-log4j2 created
configmap/apptest-5mjr3ks3-acp-conf-admin-settings created
configmap/apptest-5mjr3ks3-acp-conf-devportal-settings created
configmap/apptest-5mjr3ks3-acp-conf-publisher-settings created
configmap/redis-configuration created
configmap/redis-health created
configmap/redis-scripts created
configmap/apptest-5mjr3ks3-wso2-apk-config-ds-configmap created
configmap/apptest-5mjr3ks3-wso2-apk-wso2-apk-config-deployer-api-definition created
configmap/apptest-5mjr3ks3-wso2-apk-wso2-apk-config-generator-api-definition created
configmap/apptest-5mjr3ks3-wso2-apk-adapter-grpc-probe-script-conf created
configmap/apptest-5mjr3ks3-wso2-apk-notification-api-definition created
configmap/apptest-5mjr3ks3-wso2-apk-common-controller-grpc-probe-script-conf created
configmap/apptest-5mjr3ks3-wso2-apk-common-log-conf created
configmap/apptest-5mjr3ks3-wso2-apk-enforcer-grpc-probe-script-conf created
configmap/apptest-5mjr3ks3-wso2-apk-log-conf created
configmap/apptest-5mjr3ks3-log-conf created
clusterrole.rbac.authorization.k8s.io/wso2apk-role created
clusterrole.rbac.authorization.k8s.io/wso2agent-role created
clusterrolebinding.rbac.authorization.k8s.io/apptest-5mjr3ks3-wso2-apk-role-binding created
clusterrolebinding.rbac.authorization.k8s.io/agent-cluster-role-binding created
service/apptest-5mjr3ks3-acp-1-service created
service/apptest-5mjr3ks3-acp-service created
service/redis-headless created
service/redis-master created
service/apptest-5mjr3ks3-wso2-apk-config-ds-service created
service/apptest-5mjr3ks3-wso2-apk-adapter-service created
service/apptest-5mjr3ks3-wso2-apk-common-controller-service created
service/apptest-5mjr3ks3-wso2-apk-enforcer-service created
service/apptest-5mjr3ks3-wso2-apk-gateway-service created
service/apptest-5mjr3ks3-wso2-apk-ratelimiter-service created
service/apim-apk-agent-service created
deployment.apps/apptest-5mjr3ks3-acp-deployment-1 created
deployment.apps/apptest-5mjr3ks3-wso2-apk-config-ds-deployment created
deployment.apps/apptest-5mjr3ks3-wso2-apk-adapter-deployment created
deployment.apps/apptest-5mjr3ks3-wso2-apk-common-controller-deployment created
deployment.apps/apptest-5mjr3ks3-wso2-apk-gateway-runtime-deployment created
deployment.apps/apptest-5mjr3ks3-wso2-apk-ratelimiter-deployment created
deployment.apps/apkagent created
statefulset.apps/redis-master created
ingress.networking.k8s.io/apptest-5mjr3ks3-acp-ingress created
aiprovider.dp.wso2.com/ai-provider-azure-ai created
aiprovider.dp.wso2.com/ai-provider-mistral-ai created
aiprovider.dp.wso2.com/ai-provider-open-ai created
application.app.k8s.io/apptest-5mjr3ks3 configured
backend.dp.wso2.com/apptest-5mjr3ks3-wso2-apk-config-deployer-ds-backend created
backend.dp.wso2.com/apptest-5mjr3ks3-wso2-apk-config-generator-backend created
backend.dp.wso2.com/apptest-5mjr3ks3-wso2-apk-notification-api-backend created
backendjwt.dp.wso2.com/apptest-5mjr3ks3-wso2-apk-config-api-backendjwt created
certificate.cert-manager.io/apptest-5mjr3ks3-wso2-apk-adapter-server-cert created
certificate.cert-manager.io/apptest-5mjr3ks3-wso2-apk-common-controller-server-cert created
certificate.cert-manager.io/apptest-5mjr3ks3-wso2-apk-config-ds-server-cert created
certificate.cert-manager.io/apptest-5mjr3ks3-wso2-apk-enforcer-server-cert created
certificate.cert-manager.io/envoy-cert created
certificate.cert-manager.io/apptest-5mjr3ks3-wso2-apk-gateway-server-cert created
certificate.cert-manager.io/apptest-5mjr3ks3-wso2-apk-gw-listener-cert created
certificate.cert-manager.io/apptest-5mjr3ks3-wso2-apk-idp-listener-cert created
certificate.cert-manager.io/apptest-5mjr3ks3-wso2-apk-localhost-listener-cert created
certificate.cert-manager.io/apptest-5mjr3ks3-wso2-apk-ratelimiter-server-cert created
certificate.cert-manager.io/apptest-5mjr3ks3-wso2-apk-runtime-ds-server-cert created
certificate.cert-manager.io/apptest-5mjr3ks3-wso2-apk-system-api-listener-cert created
certificate.cert-manager.io/apptest-5mjr3ks3-wso2-apk-webhook-server-cert created
certificate.cert-manager.io/apim-apk-agent-server-cert created
clusterissuer.cert-manager.io/apptest-5mjr3ks3-wso2-apk-selfsigned-issuer created
clusterissuer.cert-manager.io/apk-agent-selfsigned-issuer configured
gateway.gateway.networking.k8s.io/wso2-apk-default created
gatewayclass.gateway.networking.k8s.io/wso2-apk-default configured
httproute.gateway.networking.k8s.io/apptest-5mjr3ks3-wso2-apk-config-api-route created
httproute.gateway.networking.k8s.io/apptest-5mjr3ks3-wso2-apk-config-deploy-api-route created
httproute.gateway.networking.k8s.io/apptest-5mjr3ks3-wso2-apk-notification-api-route created
scope.dp.wso2.com/apptest-5mjr3ks3-wso2-apk-api-create-scope created
resource mapping not found for name: "apptest-5mjr3ks3-wso2-apk-wso2-apk-config-deployer-api" namespace: "apptest-5mjr3ks3" from "/data/resources.yaml": no matches for kind "API" in version "dp.wso2.com/v1alpha3"
ensure CRDs are installed first
resource mapping not found for name: "apptest-5mjr3ks3-wso2-apk-wso2-apk-config-generator-api" namespace: "apptest-5mjr3ks3" from "/data/resources.yaml": no matches for kind "API" in version "dp.wso2.com/v1alpha3"
ensure CRDs are installed first
resource mapping not found for name: "apptest-5mjr3ks3-wso2-apk-wso2-apk-notification-api" namespace: "apptest-5mjr3ks3" from "/data/resources.yaml": no matches for kind "API" in version "dp.wso2.com/v1alpha3"
ensure CRDs are installed first
resource mapping not found for name: "apptest-5mjr3ks3-wso2-apk-config-api-api-policy" namespace: "apptest-5mjr3ks3" from "/data/resources.yaml": no matches for kind "APIPolicy" in version "dp.wso2.com/v1alpha4"
ensure CRDs are installed first
resource mapping not found for name: "apptest-5mjr3ks3-wso2-apk-configurator-api-no-authentication-policy" namespace: "apptest-5mjr3ks3" from "/data/resources.yaml": no matches for kind "Authentication" in version "dp.wso2.com/v1alpha2"
ensure CRDs are installed first
resource mapping not found for name: "apptest-5mjr3ks3-wso2-apk-notification-api-no-authentication-policy" namespace: "apptest-5mjr3ks3" from "/data/resources.yaml": no matches for kind "Authentication" in version "dp.wso2.com/v1alpha2"
ensure CRDs are installed first
resource mapping not found for name: "apptest-5mjr3ks3-wso2-apk-default-jwt-issuer" namespace: "apptest-5mjr3ks3" from "/data/resources.yaml": no matches for kind "TokenIssuer" in version "dp.wso2.com/v1alpha2"
ensure CRDs are installed first
resource mapping not found for name: "apptest-5mjr3ks3-wso2-apk-idp-jwt-issuer" namespace: "apptest-5mjr3ks3" from "/data/resources.yaml": no matches for kind "TokenIssuer" in version "dp.wso2.com/v1alpha2"
ensure CRDs are installed first
+ handle_failure
+ code=1
+ [[ -z apptest-5mjr3ks3 ]]
+ [[ -z apptest-5mjr3ks3 ]]
+ patch_assembly_phase.sh --status=Failed
+ for i in "$@"
+ case $i in
+ status=Failed
+ shift
+ [[ -z Failed ]]
+ [[ Failed =~ ^(Pending|Success|Failed)$ ]]
+ [[ -z apptest-5mjr3ks3 ]]
+ [[ -z apptest-5mjr3ks3 ]]
+ echo 'Marking deployment of application "apptest-5mjr3ks3" as "Failed".'
Marking deployment of application "apptest-5mjr3ks3" as "Failed".
+ [[ Failed == \S\u\c\c\e\s\s ]]
+ kubectl patch applications.app.k8s.io/apptest-5mjr3ks3 --output=json --namespace=apptest-5mjr3ks3 --type=merge --patch '{"spec": {"assemblyPhase": "Failed"}}'
Using /opt/kubectl/1.31/kubectl (server=1.32)
{
    "apiVersion": "app.k8s.io/v1beta1",
    "kind": "Application",
    "metadata": {
        "annotations": {
            "kubectl.kubernetes.io/last-applied-configuration": "{\"apiVersion\":\"app.k8s.io/v1beta1\",\"kind\":\"Application\",\"metadata\":{\"annotations\":{\"kubernetes-engine.cloud.google.com/icon\":\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==\",\"marketplace.cloud.google.com/deploy-info\":\"{\\\"partner_id\\\": \\\"wso2-marketplace-public\\\", \\\"product_id\\\": \\\"wso2-apim-kubernetes\\\", \\\"partner_name\\\": \\\"WSO2\\\"}\"},\"labels\":{\"app.kubernetes.io/name\":\"apptest-5mjr3ks3\"},\"name\":\"apptest-5mjr3ks3\",\"namespace\":\"apptest-5mjr3ks3\"},\"spec\":{\"componentKinds\":[{\"group\":\"apps/v1\",\"kind\":\"Deployment\"},{\"group\":\"apps/v1\",\"kind\":\"StatefulSet\"},{\"group\":\"v1\",\"kind\":\"Service\"},{\"group\":\"v1\",\"kind\":\"ConfigMap\"},{\"group\":\"v1\",\"kind\":\"Secret\"}],\"descriptor\":{\"description\":\"WSO2 API Manager provides a complete platform for building, managing, and scaling APIs.\",\"links\":[{\"description\":\"User Guide: Getting Started\",\"url\":\"https://apim.docs.wso2.com/\"},{\"description\":\"WSO2 API Manager Documentation\",\"url\":\"https://apim.docs.wso2.com/en/latest/\"}],\"maintainers\":[{\"name\":\"WSO2\",\"url\":\"https://wso2.com\"}],\"notes\":\"WSO2 API Manager has been deployed. Access the management console and API gateway according to your ingress configuration.\",\"type\":\"WSO2 API Manager\",\"version\":\"4.5.0\"},\"selector\":{\"matchLabels\":{\"app.kubernetes.io/name\":\"apptest-5mjr3ks3\"}}}}\n",
            "kubernetes-engine.cloud.google.com/icon": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==",
            "marketplace.cloud.google.com/deploy-info": "{\"partner_id\": \"wso2-marketplace-public\", \"product_id\": \"wso2-apim-kubernetes\", \"partner_name\": \"WSO2\"}"
        },
        "creationTimestamp": "2025-12-02T09:59:38Z",
        "generation": 3,
        "labels": {
            "app.kubernetes.io/name": "apptest-5mjr3ks3"
        },
        "name": "apptest-5mjr3ks3",
        "namespace": "apptest-5mjr3ks3",
        "resourceVersion": "1764669623078671015",
        "uid": "a82f27f1-84ff-4545-9bdb-186e532a17aa"
    },
    "spec": {
        "assemblyPhase": "Failed",
        "componentKinds": [
            {
                "group": "apps/v1",
                "kind": "Deployment"
            },
            {
                "group": "apps/v1",
                "kind": "StatefulSet"
            },
            {
                "group": "v1",
                "kind": "Service"
            },
            {
                "group": "v1",
                "kind": "ConfigMap"
            },
            {
                "group": "v1",
                "kind": "Secret"
            }
        ],
        "descriptor": {
            "description": "WSO2 API Manager provides a complete platform for building, managing, and scaling APIs.",
            "links": [
                {
                    "description": "User Guide: Getting Started",
                    "url": "https://apim.docs.wso2.com/"
                },
                {
                    "description": "WSO2 API Manager Documentation",
                    "url": "https://apim.docs.wso2.com/en/latest/"
                }
            ],
            "maintainers": [
                {
                    "name": "WSO2",
                    "url": "https://wso2.com"
                }
            ],
            "notes": "WSO2 API Manager has been deployed. Access the management console and API gateway according to your ingress configuration.",
            "type": "WSO2 API Manager",
            "version": "4.5.0"
        },
        "selector": {
            "matchLabels": {
                "app.kubernetes.io/name": "apptest-5mjr3ks3"
            }
        }
    }
}
+ exit 1
